<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B-Roll Semantic Search - AI-Powered Video Library</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#0f0f0f',
                            card: '#1a1a1a',
                            hover: '#252525',
                        },
                        light: {
                            bg: '#f8fafc',
                            card: '#ffffff',
                            hover: '#f1f5f9',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            transition: background-color 0.3s ease;
        }
        
        body.dark {
            background-color: #0f0f0f;
        }
        
        body:not(.dark) {
            background-color: #f8fafc;
        }
        
        .upload-zone {
            border: 2px dashed #3b82f6;
            transition: all 0.3s ease;
        }
        
        .upload-zone:hover, .upload-zone.drag-over {
            border-color: #60a5fa;
            background-color: #1e3a5f;
        }
        
        .video-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .video-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
        }
        
        .loading-spinner {
            border: 3px solid #1a1a1a;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .progress-bar {
            transition: width 0.3s ease;
        }
        
        .pulse-animation {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        
        #searchInput {
            transition: all 0.3s ease;
        }
        
        #searchInput:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="min-h-screen text-gray-100">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <header class="mb-8 flex items-center justify-between">
            <div>
                <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-blue-500 to-purple-600 bg-clip-text text-transparent">
                    üé¨ B-Roll Semantic Search
                </h1>
                <p class="text-gray-400 dark:text-gray-400">AI-powered video library with semantic search ‚Ä¢ Upload ‚Üí Transcribe ‚Üí Embed ‚Üí Search</p>
            </div>
            <button id="themeToggle" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                <span class="dark:hidden">üåô Dark</span>
                <span class="hidden dark:inline">‚òÄÔ∏è Light</span>
            </button>
        </header>

        <!-- Upload Section -->
        <section class="mb-8">
            <div class="upload-zone bg-white dark:bg-dark-card border-2 border-dashed border-blue-500 rounded-lg p-8 text-center cursor-pointer" id="uploadZone">
                <input type="file" id="fileInput" accept="video/*,.gif,image/gif" multiple class="hidden">
                <p class="text-lg mb-2">
                    <span class="text-blue-500 font-semibold">Click to upload</span> or drag and drop
                </p>
                <p class="text-sm text-gray-500">MP4, MOV, AVI, MKV, WEBM, GIF</p>
            </div>
            
            <!-- Upload Progress -->
            <div id="uploadProgress" class="mt-4 hidden">
                <div class="bg-white dark:bg-dark-card border dark:border-gray-700 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium" id="uploadStatus">Processing...</span>
                        <span class="text-sm text-gray-400" id="uploadCount">0/0</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2">
                        <div class="progress-bar bg-blue-600 h-2 rounded-full" id="progressBar" style="width: 0%"></div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2" id="currentFile"></p>
                </div>
            </div>
        </section>

        <!-- Search Section with Filter -->
        <section class="mb-8">
            <div class="flex gap-3">
                <div class="relative flex-1">
                    <input 
                        type="text" 
                        id="searchInput" 
                        placeholder="üîç Search for B-Rolls... (e.g., 'food', 'customer service', 'office scene')" 
                        class="w-full bg-white dark:bg-dark-card text-gray-900 dark:text-white border dark:border-gray-700 rounded-lg px-4 py-4 pl-12 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        autocomplete="off"
                        autocorrect="off"
                        autocapitalize="off"
                        spellcheck="false"
                    >
                    <svg class="absolute left-4 top-4 h-6 w-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    <button id="clearSearch" class="absolute right-4 top-4 text-gray-400 hover:text-white hidden">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                
                <!-- Filter Button -->
                <button 
                    id="filterToggle"
                    onclick="toggleFilter()"
                    class="px-6 py-4 rounded-lg border border-gray-700 bg-white dark:bg-dark-card text-gray-900 dark:text-white hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors flex items-center gap-2 whitespace-nowrap"
                >
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                    </svg>
                    <span class="font-medium">Filter</span>
                    <span id="filterCount" class="hidden ml-1 px-2 py-0.5 text-xs bg-blue-500 text-white rounded-full"></span>
                </button>
            </div>
            <p class="text-xs text-gray-500 dark:text-gray-500 mt-2">üí° Multi-modal AI search: Finds B-Rolls by audio transcripts + visual content (objects, scenes, actions)</p>
        </section>
        
        <!-- Filter Panel (Hidden by default) -->
        <section id="filterPanel" class="mb-8 hidden">
            <div id="filterPanelContent" class="bg-white dark:bg-dark-card border dark:border-gray-700 rounded-lg p-6 shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Filters</h3>
                    <button onclick="clearFilters()" class="text-sm text-blue-500 hover:text-blue-600">Clear All</button>
                </div>
                
                <!-- Category Filter -->
                <div class="mb-6">
                    <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Category</h4>
                    <select id="searchCategoryFilter" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500">
                        <option value="all">All Categories</option>
                        <option value="Videos">üé• Videos</option>
                        <option value="GIFs">üñºÔ∏è GIFs</option>
                        <option value="PS">üßç PS (Prateek Singh)</option>
                        <option value="Intro">üé¨ Intro</option>
                    </select>
                </div>
                
                <!-- Emotions Filter -->
                <div class="mb-6">
                    <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Emotions</h4>
                    <div class="flex flex-wrap gap-2" id="emotionFilters">
                        <!-- Dynamic emotion tags will be inserted here -->
                    </div>
                </div>
                
                <!-- Genres Filter -->
                <div class="mb-6">
                    <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Genres</h4>
                    <div class="flex flex-wrap gap-2" id="genreFilters">
                        <!-- Dynamic genre tags will be inserted here -->
                    </div>
                </div>
                
                <!-- Search Button -->
                <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <button 
                        onclick="applyFiltersAndSearch()"
                        class="w-full px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-colors flex items-center justify-center gap-2"
                    >
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <span>Search with Filters</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- Search Results Section -->
        <section id="resultsSection" class="hidden mb-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-semibold text-gray-900 dark:text-white">üéØ Search Results</h2>
                <div class="flex items-center gap-4">
                    <!-- Audio/Visual Toggle (Fixed width to prevent shifting) -->
                    <div class="flex gap-1 bg-gray-200 dark:bg-gray-700 p-1 rounded-lg" style="min-width: 220px;">
                        <button id="toggleVisual" class="flex-1 px-4 py-2 rounded-md text-sm font-medium transition-colors bg-blue-500 text-white">
                            üëÅÔ∏è Visual
                        </button>
                        <button id="toggleAudio" class="flex-1 px-4 py-2 rounded-md text-sm font-medium transition-colors text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600">
                            üéôÔ∏è Audio
                        </button>
                    </div>
                    <span id="resultCount" class="text-sm text-gray-600 dark:text-gray-400 whitespace-nowrap"></span>
                </div>
            </div>
            <div id="resultsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Results will be inserted here -->
            </div>
        </section>

        <!-- No Results State (for search) -->
        <section id="noResultsState" class="text-center py-16 hidden">
            <svg class="mx-auto h-24 w-24 text-gray-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
            <h3 class="text-xl font-semibold text-gray-500 mb-2">No matching B-Rolls found</h3>
            <p class="text-gray-600">Try a different keyword or upload more videos</p>
        </section>

        <!-- Video Library Section -->
        <section class="mb-8" id="librarySection">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-2xl font-semibold text-gray-900 dark:text-white mb-3">üìö Video Library</h2>
                    <!-- Category Pills -->
                    <div class="flex gap-2">
                        <button id="catVideos" class="category-pill px-4 py-2 rounded-full text-sm font-medium transition-colors bg-blue-500 text-white" onclick="filterLibraryByCategory('Videos')">
                            üé• Videos
                        </button>
                        <button id="catGIFs" class="category-pill px-4 py-2 rounded-full text-sm font-medium transition-colors bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600" onclick="filterLibraryByCategory('GIFs')">
                            üñºÔ∏è GIFs
                        </button>
                        <button id="catPS" class="category-pill px-4 py-2 rounded-full text-sm font-medium transition-colors bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600" onclick="filterLibraryByCategory('PS')">
                            üßç PS
                        </button>
                        <button id="catIntro" class="category-pill px-4 py-2 rounded-full text-sm font-medium transition-colors bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600" onclick="filterLibraryByCategory('Intro')">
                            üé¨ Intro
                        </button>
                    </div>
                </div>
                <button id="refreshLibrary" class="text-blue-500 hover:text-blue-400 text-sm flex items-center gap-2">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Refresh
                </button>
            </div>
            <div id="libraryGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Library items will be inserted here -->
            </div>
        </section>

        <!-- Empty Library State -->
        <section id="emptyState" class="text-center py-16 hidden">
            <svg class="mx-auto h-24 w-24 text-gray-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z"/>
            </svg>
            <h3 class="text-xl font-semibold text-gray-500 mb-2">No videos in library yet</h3>
            <p class="text-gray-600">Upload your first video to build your AI-powered B-Roll library</p>
        </section>

        <!-- Video Player Modal -->
        <div id="videoModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50">
            <div class="bg-dark-card rounded-lg p-6 max-w-4xl w-full mx-4 relative">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold" id="modalTitle">Video Player</h3>
                    <button id="closeModal" class="text-gray-400 hover:text-white">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                
                <!-- Video Container with Navigation Arrows Overlay -->
                <div class="relative mb-4">
                    <video id="videoPlayer" class="w-full rounded-lg" controls preload="metadata"></video>
                    <div id="videoLoading" class="hidden absolute inset-0 bg-black bg-opacity-70 flex items-center justify-center rounded-lg">
                        <div class="text-white text-center">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-2"></div>
                            <p class="text-sm">Loading video...</p>
                        </div>
                    </div>
                    
                    <!-- Previous Arrow (Left Side) -->
                    <button id="prevResult" class="absolute left-2 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 hover:bg-opacity-70 text-white rounded-full p-3 transition-all disabled:opacity-30 disabled:cursor-not-allowed z-10" title="Previous result">
                        <svg class="h-8 w-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7"/>
                        </svg>
                    </button>
                    
                    <!-- Next Arrow (Right Side) -->
                    <button id="nextResult" class="absolute right-2 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 hover:bg-opacity-70 text-white rounded-full p-3 transition-all disabled:opacity-30 disabled:cursor-not-allowed z-10" title="Next result">
                        <svg class="h-8 w-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7"/>
                        </svg>
                    </button>
                </div>
                <img id="gifPlayer" class="w-full rounded-lg mb-4 hidden" alt="GIF player">
                <div class="bg-dark-bg rounded p-4 max-h-96 overflow-y-auto">
                    <p class="text-sm text-gray-400 mb-2 sticky top-0 bg-dark-bg pb-2">Transcript:</p>
                    <p id="clipTranscript" class="text-gray-200"></p>
                    <div class="mt-3 flex items-center text-sm text-gray-500">
                        <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span id="timeInfo">Clip window</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Selection Modal -->
    <div id="categoryModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-8 max-w-md w-full mx-4 shadow-2xl">
            <h3 class="text-2xl font-semibold text-gray-900 dark:text-white mb-6">Select Category</h3>
            <p class="text-gray-600 dark:text-gray-400 mb-6">Choose a category for your upload:</p>
            
            <div class="space-y-3 mb-6">
                <button id="categoryVideosBtn" class="w-full px-6 py-4 rounded-lg text-left font-medium transition-colors bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 flex items-center gap-3">
                    <span class="text-2xl">üé•</span>
                    <div>
                        <div class="font-semibold">Videos</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">Movies, scenes, and video content</div>
                    </div>
                </button>
                
                <button id="categoryGIFsBtn" class="w-full px-6 py-4 rounded-lg text-left font-medium transition-colors bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 flex items-center gap-3">
                    <span class="text-2xl">üñºÔ∏è</span>
                    <div>
                        <div class="font-semibold">GIFs</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">Animated GIFs and short loops</div>
                    </div>
                </button>
                
                <button id="categoryPSBtn" class="w-full px-6 py-4 rounded-lg text-left font-medium transition-colors bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600">
                    <div class="font-semibold">üßç PS (Prateek Singh)</div>
                    <div class="text-sm text-gray-500 dark:text-gray-400">Content from Prateek Singh</div>
                </button>
                
                <button id="categoryIntroBtn" class="w-full px-6 py-4 rounded-lg text-left font-medium transition-colors bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 flex items-center gap-3">
                    <span class="text-2xl">üé¨</span>
                    <div>
                        <div class="font-semibold">Intro</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">YouTube creator intros (max 30s)</div>
                    </div>
                </button>
            </div>
            
            <div class="flex gap-3">
                <button id="closeCategoryModal" class="flex-1 px-6 py-3 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 font-medium transition-colors">
                    Cancel
                </button>
                <button onclick="proceedWithUpload()" class="flex-1 px-6 py-3 rounded-lg bg-blue-500 text-white hover:bg-blue-600 font-medium transition-colors">
                    Upload
                </button>
            </div>
        </div>
    </div>

    <script>
        // Auto-detect if running locally or on Railway
        const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:5002'
            : window.location.origin;
        
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const searchInput = document.getElementById('searchInput');
        const resultsSection = document.getElementById('resultsSection');
        const resultsGrid = document.getElementById('resultsGrid');
        const emptyState = document.getElementById('emptyState');
        const videoModal = document.getElementById('videoModal');
        const videoPlayer = document.getElementById('videoPlayer');
        const gifPlayer = document.getElementById('gifPlayer');
        const uploadProgress = document.getElementById('uploadProgress');
        const progressBar = document.getElementById('progressBar');
        const uploadStatus = document.getElementById('uploadStatus');
        const uploadCount = document.getElementById('uploadCount');
        const currentFile = document.getElementById('currentFile');
        const libraryGrid = document.getElementById('libraryGrid');
        const refreshLibrary = document.getElementById('refreshLibrary');
        const clearSearch = document.getElementById('clearSearch');
        const resultCount = document.getElementById('resultCount');
        const noResultsState = document.getElementById('noResultsState');
        const librarySection = document.getElementById('librarySection');
        
        // Category and filter state variables (must be declared early!)
        let currentLibraryCategory = 'Videos'; // default
        let allLibraryVideos = [];
        let currentResultsFilter = 'visual'; // default to visual
        let allSearchResults = []; // Store all results
        let currentDisplayedResults = []; // Currently displayed filtered results
        let currentResultIndex = -1; // Track which result is playing
        let clipRatings = JSON.parse(localStorage.getItem('clipRatings') || '{}'); // {clipId: rating}
        let selectedStars = 0;

        // Theme toggle functionality
        const themeToggle = document.getElementById('themeToggle');
        const htmlElement = document.documentElement;
        const bodyElement = document.body;
        
        // Load saved theme or default to light
        const savedTheme = localStorage.getItem('theme') || 'light';
        if (savedTheme === 'dark') {
            htmlElement.classList.add('dark');
            bodyElement.classList.add('dark');
        } else {
            htmlElement.classList.remove('dark');
            bodyElement.classList.remove('dark');
        }
        
        themeToggle.addEventListener('click', () => {
            htmlElement.classList.toggle('dark');
            bodyElement.classList.toggle('dark');
            
            // Save preference
            const newTheme = htmlElement.classList.contains('dark') ? 'dark' : 'light';
            localStorage.setItem('theme', newTheme);
        });
        
        // Load video library on page load
        loadLibrary();

        // Upload zone interactions - show category modal first
        uploadZone.addEventListener('click', () => {
            // Trigger file selection but capture in a temp variable
            fileInput.click();
        });

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('drag-over');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('drag-over');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
            showCategoryModal(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                showCategoryModal(e.target.files);
            }
        });

        refreshLibrary.addEventListener('click', loadLibrary);

        // Clear search button
        clearSearch.addEventListener('click', () => {
            searchInput.value = '';
            clearSearch.classList.add('hidden');
            resultsSection.classList.add('hidden');
            noResultsState.classList.add('hidden');
            librarySection.classList.remove('hidden');
            if (libraryGrid.children.length === 0) {
                emptyState.classList.remove('hidden');
            }
        });

        // Show/hide clear button based on input
        searchInput.addEventListener('input', (e) => {
            if (e.target.value.trim()) {
                clearSearch.classList.remove('hidden');
            } else {
                clearSearch.classList.add('hidden');
            }
        });

        // File upload handler
        async function handleFilesWithCategory(files, category) {
            if (files.length === 0) return;

            uploadProgress.classList.remove('hidden');

            const totalFiles = files.length;
            let completed = 0;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                currentFile.textContent = `Processing: ${file.name} (Transcribing + Creating embeddings...)`;

                const formData = new FormData();
                formData.append('file', file);
                formData.append('category', category);

                try {
                    console.log(`üì§ Uploading: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB) to category: ${category}`);
                    const response = await fetch(`${API_BASE}/upload`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    console.log(`üì° Response status: ${response.status}`);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`‚ùå Server error (${response.status}):`, errorText);
                        throw new Error(`Server returned ${response.status}: ${errorText}`);
                    }
                    
                    const result = await response.json();
                    console.log('üìä Result:', result);
                    
                    if (result.success) {
                        completed++;
                        uploadCount.textContent = `${completed}/${totalFiles}`;
                        progressBar.style.width = `${(completed / totalFiles) * 100}%`;
                        console.log(`‚úÖ Successfully uploaded: ${file.name}`);
                    } else {
                        console.error('‚ùå Upload failed:', result.error);
                        alert(`Failed to process ${file.name}:\n\n${result.error}\n\nCheck console (F12) for details.`);
                    }
                } catch (error) {
                    console.error('‚ùå Error uploading file:', error);
                    alert(`Error uploading ${file.name}:\n\n${error.message}\n\nCheck console (F12) for details.`);
                }
            }
            
            uploadStatus.textContent = '‚úÖ Complete!';
            currentFile.textContent = 'All videos processed and embeddings created. Ready for semantic search!';
            
            // Reload library
            setTimeout(() => {
                loadLibrary();
                uploadProgress.classList.add('hidden');
                progressBar.style.width = '0%';
                uploadStatus.textContent = 'Processing...';
                fileInput.value = '';
            }, 2000);
        }

        // Load video library
        async function loadLibrary() {
            try {
                const response = await fetch(`${API_BASE}/videos?t=${Date.now()}`, {
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache'
                    }
                });
                const data = await response.json();
                
                // Store all videos for category filtering
                allLibraryVideos = data.videos;

                libraryGrid.innerHTML = '';

                if (data.videos.length === 0) {
                    // Only show empty state if not searching
                    if (!searchInput.value.trim()) {
                        emptyState.classList.remove('hidden');
                        librarySection.classList.remove('hidden');
                    }
                    return;
                }

                emptyState.classList.add('hidden');
                // Only show library if not actively searching
                if (!searchInput.value.trim()) {
                    librarySection.classList.remove('hidden');
                }

                // Filter by current category (handle videos without category as 'Videos')
                const filtered = data.videos.filter(v => (v.category || 'Videos') === currentLibraryCategory);
                
                filtered.forEach(video => {
                    const card = createVideoCard(video);
                    libraryGrid.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading library:', error);
            }
        }
        
        // Create video card element
        function createVideoCard(video) {
            const card = document.createElement('div');
            card.className = 'bg-white dark:bg-dark-card border dark:border-gray-700 rounded-lg overflow-hidden hover:ring-2 hover:ring-blue-500 transition-all cursor-pointer';

            // Make card clickable to play first clip
            card.onclick = () => playVideoFromLibrary(video);
            
            const statusIcon = video.status === 'complete' ? '‚úÖ' : 
                             video.status === 'processing' ? '‚è≥' : '‚ùå';
            const statusColor = video.status === 'complete' ? 'text-green-500' : 
                              video.status === 'processing' ? 'text-yellow-500 pulse-animation' : 'text-red-500';
            
            const thumbnailUrl = video.thumbnail ? `${API_BASE}/thumbnails/${video.thumbnail}` : '';
            
            card.innerHTML = `
                        <div class="relative group">
                            ${video.thumbnail ? `
                                <img src="${thumbnailUrl}" alt="${video.filename}" class="w-full h-32 object-cover">
                            ` : `
                                <div class="w-full h-32 bg-gradient-to-br from-gray-700 to-gray-900 flex items-center justify-center">
                                    <svg class="h-16 w-16 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"/>
                                    </svg>
                                </div>
                            `}
                            <div class="absolute top-2 right-2 ${statusColor} text-lg bg-black bg-opacity-70 rounded-full p-1">${statusIcon}</div>
                            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 transition-all flex items-center justify-center">
                                <svg class="h-16 w-16 text-white opacity-0 group-hover:opacity-80 transition-opacity" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"/>
                                </svg>
                            </div>
                            <div class="absolute bottom-2 left-2 right-2 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button 
                                    id="genVisBtn_${video.id}"
                                    class="flex-1 bg-purple-500 hover:bg-purple-600 text-white text-xs px-3 py-1 rounded font-medium transition-colors" 
                                    onclick="event.stopPropagation(); reprocessVideoWithUI(${video.id}, '${video.filename}')"
                                >
                                    üé® Generate Visuals
                                </button>
                                <button class="bg-red-500 hover:bg-red-600 text-white text-xs px-3 py-1 rounded" onclick="event.stopPropagation(); deleteVideo(${video.id}, '${video.filename}')">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                        <div class="p-4">
                            <div class="flex items-start justify-between mb-2">
                                <h3 class="font-semibold text-sm truncate flex-1 text-gray-900 dark:text-white">${video.filename}</h3>
                            </div>
                            <div class="text-xs text-gray-700 dark:text-gray-400 space-y-1">
                                <p class="font-medium">‚è±Ô∏è Duration: ${formatTime(video.duration)}</p>
                                <p class="font-medium">üìù Clips: ${video.clip_count}</p>
                                <p class="text-gray-500 dark:text-gray-500">üìÖ ${new Date(video.upload_date).toLocaleString()}</p>
                            </div>
                            
                            <!-- Custom Tags Section -->
                            <div id="customTags_${video.id}" class="mt-3">
                                ${renderCustomTags(video.id, video.custom_tags || '')}
                            </div>
                            
                            <!-- Add Tag Button -->
                            <button 
                                class="mt-2 w-full bg-blue-50 dark:bg-blue-900/20 hover:bg-blue-100 dark:hover:bg-blue-900/30 text-blue-600 dark:text-blue-400 text-xs px-3 py-1.5 rounded border border-blue-200 dark:border-blue-800 font-medium transition-colors flex items-center justify-center gap-1"
                                onclick="event.stopPropagation(); addCustomTag(${video.id}, '${video.filename}')"
                            >
                                <span class="text-base">+</span> Add Tag
                            </button>
                        </div>
                    `;

            return card;
        }

        // Search functionality with debouncing and race condition protection
        let searchTimeout;
        let searchAbortController = null;
        let searchRequestId = 0;
        
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            
            // Cancel any in-flight search requests
            if (searchAbortController) {
                searchAbortController.abort();
                searchAbortController = null;
            }
            
            const query = e.target.value.trim();

            // If search is empty, show library
            if (!query) {
                resultsSection.classList.add('hidden');
                noResultsState.classList.add('hidden');
                librarySection.classList.remove('hidden');
                if (libraryGrid.children.length === 0) {
                    emptyState.classList.remove('hidden');
                }
                return;
            }

            // Hide library when user starts typing
            librarySection.classList.add('hidden');
            emptyState.classList.add('hidden');

            // Debounce search
            searchTimeout = setTimeout(() => {
                performSearch(query);
            }, 300);
        });

        // Toggle category tags expand/collapse
        function toggleCategoryTags(categoryId) {
            const hiddenTags = document.getElementById(`hidden_${categoryId}`);
            const chevron = document.getElementById(`chevron_${categoryId}`);
            const buttonText = document.getElementById(`text_${categoryId}`);
            
            if (hiddenTags && chevron && buttonText) {
                const isExpanded = hiddenTags.style.display !== 'none';
                
                if (isExpanded) {
                    // Collapse
                    hiddenTags.style.display = 'none';
                    chevron.style.transform = 'rotate(0deg)';
                    const hiddenCount = hiddenTags.querySelectorAll('span').length;
                    buttonText.textContent = `+${hiddenCount} more`;
                } else {
                    // Expand
                    hiddenTags.style.display = 'inline-flex';
                    hiddenTags.style.flexWrap = 'wrap';
                    hiddenTags.style.gap = '0.25rem';
                    chevron.style.transform = 'rotate(180deg)';
                    buttonText.textContent = 'Show less';
                }
            }
        }

        async function performSearch(query) {
            try {
                // Create unique ID for this search request
                const currentRequestId = ++searchRequestId;
                
                // Cancel previous search if exists
                if (searchAbortController) {
                    searchAbortController.abort();
                }
                
                // Create new abort controller for this search
                searchAbortController = new AbortController();
                
                // Get category filter from dropdown
                const searchCategoryFilter = document.getElementById('searchCategoryFilter');
                const selectedCategory = searchCategoryFilter ? searchCategoryFilter.value : 'all';
                const categoriesArray = selectedCategory === 'all' ? [] : [selectedCategory];
                
                console.log(`üîç Search #${currentRequestId}:`, query);
                console.log('üé≠ Emotion filters:', Array.from(selectedEmotions));
                console.log('üé¨ Genre filters:', Array.from(selectedGenres));
                console.log('üìÅ Category filter:', selectedCategory);

                // Show loading state
                resultsSection.classList.remove('hidden');
                resultsGrid.innerHTML = '<div class="col-span-full text-center py-12"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div><p class="text-gray-600 dark:text-gray-400">Searching...</p></div>';

                const response = await fetch(`${API_BASE}/search?t=${Date.now()}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache'
                    },
                    body: JSON.stringify({
                        query,
                        emotions: Array.from(selectedEmotions),
                        genres: Array.from(selectedGenres),
                        categories: categoriesArray
                    }),
                    signal: searchAbortController.signal
                });

                console.log(`üì° Response #${currentRequestId} status:`, response.status);
                const data = await response.json();
                
                // Ignore response if it's from an outdated search
                if (currentRequestId !== searchRequestId) {
                    console.log(`‚è≠Ô∏è Ignoring stale response #${currentRequestId} (current: ${searchRequestId})`);
                    return;
                }
                
                console.log('üìä Results received:', data.results.length, 'items');
                displayResults(data.results, query);
                
                // Clear the abort controller after successful completion
                searchAbortController = null;
            } catch (error) {
                // Ignore aborted requests
                if (error.name === 'AbortError') {
                    console.log('üö´ Search request aborted');
                    return;
                }
                
                console.error('‚ùå Search error:', error);
                noResultsState.classList.remove('hidden');
                resultsSection.classList.add('hidden');
            }
        }

        function displayResults(results, query, storeResults = true) {
            console.log('üé® Displaying results:', results.length, 'items for query:', query);
            
            // Store all results for audio/visual toggling
            if (storeResults) {
                allSearchResults = results;
            }
            
            // Filter by current toggle (visual/audio)
            let filtered = results.filter(r => r.source === currentResultsFilter);
            console.log(`üîÑ Filtered to ${currentResultsFilter}:`, filtered.length, 'items');
            
            // Apply rating boost to sort results
            filtered = filtered.map(r => {
                const rating = clipRatings[r.id] || 0;
                const ratingBoost = rating * 0.05; // Each star adds 0.05 to similarity
                return { ...r, originalSimilarity: r.similarity, similarity: r.similarity + ratingBoost, userRating: rating };
            }).sort((a, b) => b.similarity - a.similarity);
            
            // Store for navigation
            currentDisplayedResults = filtered;
            
            resultsGrid.innerHTML = '';

            // If no results after filtering, show empty state
            if (!filtered || filtered.length === 0) {
                console.log('‚ö†Ô∏è No results to display');
                resultsSection.classList.add('hidden');
                noResultsState.classList.remove('hidden');
                // Update empty state text
                const emptyStateText = noResultsState.querySelector('p');
                if (emptyStateText) {
                    const filterType = currentResultsFilter === 'visual' ? 'Visual' : 'Audio';
                    emptyStateText.textContent = `No ${filterType} results found for "${query}". Try the other filter or different keywords.`;
                }
                return;
            }

            // Show results, hide empty state
            console.log('‚úÖ Showing results section');
            noResultsState.classList.add('hidden');
            resultsSection.classList.remove('hidden');
            const totalCount = allSearchResults.length;
            const filterType = currentResultsFilter === 'visual' ? 'Visual' : 'Audio';
            resultCount.textContent = `${filtered.length} ${filterType} result${filtered.length === 1 ? '' : 's'} (${totalCount} total) for "${query}"`;

            filtered.forEach((result, index) => {
                console.log(`  üìå Result ${index + 1}:`, result.filename, 'similarity:', result.similarity, 'rating:', result.userRating || 0);
                const card = document.createElement('div');
                card.className = 'video-card bg-white dark:bg-dark-card border dark:border-gray-700 rounded-lg overflow-hidden cursor-pointer';
                card.onclick = () => playClip(result, index);
                
                const similarityPercent = (result.similarity * 100).toFixed(1);
                const matchColor = result.similarity > 0.7 ? 'text-green-500' : 
                                  result.similarity > 0.5 ? 'text-yellow-500' : 'text-gray-500';
                
                // Determine source badge with music detection
                const isVisual = result.source === 'visual';
                const isMusic = !isVisual && result.text === '‚ô™‚ô™';
                const sourceBadge = isVisual 
                    ? '<span class="bg-purple-500 text-white text-xs px-2 py-1 rounded">üé® Visual</span>'
                    : isMusic
                    ? '<span class="bg-indigo-500 text-white text-xs px-2 py-1 rounded">üéµ Music</span>'
                    : '<span class="bg-blue-500 text-white text-xs px-2 py-1 rounded">üé§ Audio</span>';
                
                // Emotion badge REMOVED - emotions now shown in categorized tags below
                
                // OCR text badge (if visual and has OCR text)
                let ocrBadge = '';
                if (isVisual && result.ocr_text) {
                    ocrBadge = `<div class="mt-2 text-xs bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-2 py-1 rounded"><strong>üìù Text:</strong> "${result.ocr_text.substring(0, 50)}${result.ocr_text.length > 50 ? '...' : ''}"</div>`;
                }
                
                // Custom tags badge (HIGHEST PRIORITY - appears first!)
                let customTagsBadge = '';
                if (isVisual && result.custom_tags) {
                    const customTags = result.custom_tags.split(',').map(t => t.trim()).filter(t => t);
                    if (customTags.length > 0) {
                        const customTagItems = customTags.map(tag => 
                            `<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 border border-green-300 dark:border-green-700 hover:bg-green-200 dark:hover:bg-green-800 cursor-pointer">
                                <span onclick="event.stopPropagation(); searchInput.value='${tag.replace(/'/g, "\\'")}'; performSearch('${tag.replace(/'/g, "\\'")}');">üè∑Ô∏è ${tag}</span>
                                <button class="ml-1 hover:text-red-600 dark:hover:text-red-400 font-bold" onclick="event.stopPropagation(); deleteCustomTagFromResult(${result.video_id}, '${tag.replace(/'/g, "\\'")}', ${index})" title="Delete tag">√ó</button>
                            </span>`
                        ).join(' ');
                        
                        customTagsBadge = `<div class="mt-2"><p class="text-xs font-semibold text-gray-600 dark:text-gray-400 mb-1 flex items-center gap-2">
                            <span>Custom Tags:</span>
                            <button class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-2 py-0.5 rounded" onclick="event.stopPropagation(); addCustomTagFromResult(${result.video_id}, '${result.filename}', ${index})">+ Add</button>
                        </p><div class="flex flex-wrap gap-1">${customTagItems}</div></div>`;
                    } else {
                        // Show "Add Tag" button even when no custom tags exist
                        customTagsBadge = `<div class="mt-2">
                            <button class="text-xs bg-blue-50 dark:bg-blue-900/20 hover:bg-blue-100 dark:hover:bg-blue-900/30 text-blue-600 dark:text-blue-400 px-3 py-1 rounded border border-blue-200 dark:border-blue-800 font-medium flex items-center gap-1" onclick="event.stopPropagation(); addCustomTagFromResult(${result.video_id}, '${result.filename}', ${index})">
                                <span class="text-base">+</span> Add Custom Tag
                            </button>
                        </div>`;
                    }
                } else if (isVisual) {
                    // Always show "Add Tag" button for visual results
                    customTagsBadge = `<div class="mt-2">
                        <button class="text-xs bg-blue-50 dark:bg-blue-900/20 hover:bg-blue-100 dark:hover:bg-blue-900/30 text-blue-600 dark:text-blue-400 px-3 py-1 rounded border border-blue-200 dark:border-blue-800 font-medium flex items-center gap-1" onclick="event.stopPropagation(); addCustomTagFromResult(${result.video_id}, '${result.filename}', ${index})">
                            <span class="text-base">+</span> Add Custom Tag
                        </button>
                    </div>`;
                }
                
                // AI-generated tags badge - NEW 5-CATEGORY SYSTEM WITH FALLBACK
                let tagsBadge = '';
                if (isVisual) {
                    // Parse categorized tags from backend
                    const emotionTagsArray = result.emotion_tags ? result.emotion_tags.replace(/[\[\]']/g, '').split(',').map(t => t.trim()).filter(t => t) : [];
                    const laughTagsArray = result.laugh_tags ? result.laugh_tags.replace(/[\[\]']/g, '').split(',').map(t => t.trim()).filter(t => t) : [];
                    const contextualTagsArray = result.contextual_tags ? result.contextual_tags.replace(/[\[\]']/g, '').split(',').map(t => t.trim()).filter(t => t) : [];
                    const characterTagsArray = result.character_tags ? result.character_tags.replace(/[\[\]']/g, '').split(',').map(t => t.trim()).filter(t => t) : [];
                    const semanticTagsArray = result.semantic_tags ? result.semantic_tags.replace(/[\[\]']/g, '').split(',').map(t => t.trim()).filter(t => t) : [];
                    
                    const hasNewTags = emotionTagsArray.length > 0 || laughTagsArray.length > 0 || contextualTagsArray.length > 0 || characterTagsArray.length > 0 || semanticTagsArray.length > 0;
                    
                    if (hasNewTags) {
                        // NEW SYSTEM: Show 5 categorized sections
                        const uniqueId = `tags_${index}_${Date.now()}`;
                        let categoriesHTML = '';
                        
                        // Helper function to render tag category with expand/collapse
                        const renderCategory = (title, emoji, tags, bgColor) => {
                            // ALWAYS show Laugh Tags section (even if empty)
                            const isLaughTags = title === 'Laugh Type Tags';
                            if (tags.length === 0 && !isLaughTags) return '';
                            
                            const categoryId = `category_${title.replace(/\s+/g, '_')}_${index}_${Date.now()}`;
                            const maxVisible = 3;
                            const hasMore = tags.length > maxVisible;
                            
                            // First 3 tags
                            const visibleTags = tags.slice(0, maxVisible);
                            const hiddenTags = tags.slice(maxVisible);
                            
                            // If Laugh Tags section is empty, show a message
                            if (isLaughTags && tags.length === 0) {
                                return `<div class="mb-2">
                                    <p class="text-xs font-semibold text-gray-600 dark:text-gray-400 mb-1">${emoji} ${title}:</p>
                                    <div class="flex flex-wrap gap-1">
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400 italic">No laughing/smiling detected in this scene</span>
                                    </div>
                                </div>`;
                            }
                            
                            const visibleTagsHTML = visibleTags.map(tag => 
                                `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${bgColor} hover:opacity-80 cursor-pointer" onclick="event.stopPropagation(); searchInput.value='${tag.replace(/'/g, "\\'")}'; performSearch('${tag.replace(/'/g, "\\'")}');">${tag}</span>`
                            ).join(' ');
                            
                            const hiddenTagsHTML = hasMore ? hiddenTags.map(tag => 
                                `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${bgColor} hover:opacity-80 cursor-pointer" onclick="event.stopPropagation(); searchInput.value='${tag.replace(/'/g, "\\'")}'; performSearch('${tag.replace(/'/g, "\\'")}');">${tag}</span>`
                            ).join(' ') : '';
                            
                            const expandButton = hasMore ? 
                                `<button 
                                    id="toggle_${categoryId}" 
                                    onclick="event.stopPropagation(); toggleCategoryTags('${categoryId}')" 
                                    class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors cursor-pointer">
                                    <span id="text_${categoryId}">+${hiddenTags.length} more</span>
                                    <svg id="chevron_${categoryId}" class="ml-1 h-3 w-3 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>` : '';
                            
                            return `<div class="mb-2">
                                <p class="text-xs font-semibold text-gray-600 dark:text-gray-400 mb-1">${emoji} ${title}:</p>
                                <div class="flex flex-wrap gap-1">
                                    ${visibleTagsHTML}
                                    <span id="hidden_${categoryId}" class="hidden flex-wrap gap-1" style="display: none;">
                                        ${hiddenTagsHTML}
                                    </span>
                                    ${expandButton}
                                </div>
                            </div>`;
                        };
                        
                        // 1Ô∏è‚É£ Emotion Tags
                        categoriesHTML += renderCategory('Emotion Tags', 'üé≠', emotionTagsArray, 'bg-pink-100 dark:bg-pink-900 text-pink-800 dark:text-pink-200');
                        
                        // 2Ô∏è‚É£ Laugh Type Tags
                        categoriesHTML += renderCategory('Laugh Type Tags', 'üòÇ', laughTagsArray, 'bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200');
                        
                        // 3Ô∏è‚É£ Contextual Tags
                        categoriesHTML += renderCategory('Contextual Tags', 'üé¨', contextualTagsArray, 'bg-indigo-100 dark:bg-indigo-900 text-indigo-800 dark:text-indigo-200');
                        
                        // 4Ô∏è‚É£ Character Tags
                        categoriesHTML += renderCategory('Character Tags', 'üë•', characterTagsArray, 'bg-amber-100 dark:bg-amber-900 text-amber-800 dark:text-amber-200');
                        
                        // 5Ô∏è‚É£ Semantic Tags
                        categoriesHTML += renderCategory('Semantic Tags', 'üîé', semanticTagsArray, 'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200');
                        
                        tagsBadge = `<div class="mt-3 border-t dark:border-gray-700 pt-3">
                            <p class="text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">AI Tags</p>
                            <div id="${uniqueId}">${categoriesHTML}</div>
                        </div>`;
                    } else if (result.tags) {
                        // FALLBACK: Show old tags system (for videos not yet reprocessed)
                        const allTags = result.tags.split(',').map(t => t.trim()).filter(t => t);
                        if (allTags.length > 0) {
                            const uniqueId = `tags_${index}_${Date.now()}`;
                            const first5Tags = allTags.slice(0, 5);
                            const remainingCount = allTags.length - 5;
                            
                            const tagItems = first5Tags.map(tag => 
                                `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 hover:opacity-80 cursor-pointer" onclick="event.stopPropagation(); searchInput.value='${tag.replace(/'/g, "\\'")}'; performSearch('${tag.replace(/'/g, "\\'")}');">${tag}</span>`
                            ).join(' ');
                            
                            const expandButton = remainingCount > 0 
                                ? `<button class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700" onclick="event.stopPropagation(); toggleAllTags('${uniqueId}', ${JSON.stringify(allTags).replace(/"/g, '&quot;')})">+${remainingCount} more</button>`
                                : '';
                            
                            tagsBadge = `<div class="mt-2 border-t dark:border-gray-700 pt-2">
                                <p class="text-xs font-semibold text-gray-600 dark:text-gray-400 mb-1">AI Tags (Old Format - Reprocess for Categories):</p>
                                <div id="${uniqueId}" class="flex flex-wrap gap-1 items-center">${tagItems} ${expandButton}</div>
                            </div>`;
                        }
                    }
                }
                
                // Get thumbnail from filename
                const thumbnailName = `thumb_${result.filename.replace(/\.[^/.]+$/, '')}.jpg`;
                const thumbnailUrl = `${API_BASE}/thumbnails/${thumbnailName}`;
                
                // Star rating display
                const userRating = result.userRating || 0;
                const starDisplay = Array(5).fill(0).map((_, i) => 
                    i < userRating ? '‚≠ê' : '‚òÜ'
                ).join('');
                const clipIdForRating = result.id || result.clip_id || index;
                
                card.innerHTML = `
                    <div class="relative">
                        <img src="${thumbnailUrl}" alt="${result.filename}" class="w-full h-32 object-cover" onerror="this.style.display='none'">
                        <div class="absolute top-2 right-2 flex flex-col items-end gap-1">
                            <div class="flex items-center gap-2 bg-black bg-opacity-80 px-2 py-1 rounded">
                                <span class="${matchColor} text-xs font-bold">üéØ ${similarityPercent}%</span>
                                <button 
                                    class="text-yellow-400 hover:text-yellow-300 transition-all" 
                                    onclick="event.stopPropagation(); showStarRating('${clipIdForRating}', ${index})"
                                    title="Rate this clip"
                                >
                                    <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                    </svg>
                                </button>
                            </div>
                            ${userRating > 0 ? `<div class="text-xs bg-yellow-500 text-black px-2 py-0.5 rounded font-bold">${starDisplay}</div>` : ''}
                        </div>
                        <div class="absolute top-2 left-2 flex gap-1">
                            ${sourceBadge}
                        </div>
                    </div>
                    <div class="p-4">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-semibold text-sm truncate flex-1 text-gray-900 dark:text-white">${result.filename}</h3>
                        </div>
                        <p class="text-gray-600 dark:text-gray-400 text-sm mb-3 line-clamp-3">${result.text}</p>
                        ${ocrBadge}
                        ${customTagsBadge}
                        ${tagsBadge}
                        <div class="flex items-center text-xs text-gray-500 dark:text-gray-500 mt-2">
                            <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            ${formatTime(result.start_time)} - ${formatTime(result.end_time)}
                        </div>
                    </div>
                `;
                
                resultsGrid.appendChild(card);
            });
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        // Toggle all tags display (expand/collapse)
        function toggleAllTags(uniqueId, allTags) {
            const container = document.getElementById(uniqueId);
            if (!container) return;
            
            const currentlyExpanded = container.dataset.expanded === 'true';
            
            if (currentlyExpanded) {
                // Collapse: Show only first 3 + expand button
                const first3Tags = allTags.slice(0, 3);
                const remainingCount = allTags.length - 3;
                
                const tagItems = first3Tags.map(tag => 
                    `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 hover:bg-blue-200 dark:hover:bg-blue-800 cursor-pointer" onclick="event.stopPropagation(); searchInput.value='${tag.replace(/'/g, "\\'")}'; performSearch('${tag.replace(/'/g, "\\'")}');">${tag}</span>`
                ).join(' ');
                
                const expandButton = `<button class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700" onclick="event.stopPropagation(); toggleAllTags('${uniqueId}', ${JSON.stringify(allTags).replace(/"/g, '&quot;')})">+${remainingCount} more</button>`;
                
                container.innerHTML = `${tagItems} ${expandButton}`;
                container.dataset.expanded = 'false';
            } else {
                // Expand: Show all tags + collapse button
                const tagItems = allTags.map(tag => 
                    `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 hover:bg-blue-200 dark:hover:bg-blue-800 cursor-pointer" onclick="event.stopPropagation(); searchInput.value='${tag.replace(/'/g, "\\'")}'; performSearch('${tag.replace(/'/g, "\\'")}');">${tag}</span>`
                ).join(' ');
                
                const collapseButton = `<button class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700" onclick="event.stopPropagation(); toggleAllTags('${uniqueId}', ${JSON.stringify(allTags).replace(/"/g, '&quot;')})">Show less</button>`;
                
                container.innerHTML = `${tagItems} ${collapseButton}`;
                container.dataset.expanded = 'true';
            }
        }
        
        // ========== CUSTOM TAG FUNCTIONALITY ==========
        
        // Render custom tags with delete buttons
        function renderCustomTags(videoId, customTagsString) {
            if (!customTagsString || !customTagsString.trim()) {
                return '<p class="text-xs text-gray-500 dark:text-gray-600 italic">No custom tags yet</p>';
            }
            
            const tags = customTagsString.split(',').map(t => t.trim()).filter(t => t);
            
            if (tags.length === 0) {
                return '<p class="text-xs text-gray-500 dark:text-gray-600 italic">No custom tags yet</p>';
            }
            
            const tagBadges = tags.map(tag => `
                <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 border border-green-300 dark:border-green-700">
                    <span class="cursor-pointer hover:underline" onclick="event.stopPropagation(); searchInput.value='${tag.replace(/'/g, "\\'")}'; performSearch('${tag.replace(/'/g, "\\'")}')">${tag}</span>
                    <button 
                        class="ml-1 hover:text-red-600 dark:hover:text-red-400 transition-colors font-bold"
                        onclick="event.stopPropagation(); deleteCustomTag(${videoId}, '${tag.replace(/'/g, "\\'")}')"
                        title="Delete tag"
                    >√ó</button>
                </span>
            `).join(' ');
            
            return `<div class="flex flex-wrap gap-1 items-center">${tagBadges}</div>`;
        }
        
        // Add custom tag to video
        async function addCustomTag(videoId, filename) {
            const tag = prompt(`Add custom tag for "${filename}":\n\nExamples:\n‚Ä¢ client-ad\n‚Ä¢ intro-shot\n‚Ä¢ b-roll-pack-1\n‚Ä¢ project-abc`);
            
            if (!tag || !tag.trim()) {
                return; // User cancelled or entered empty tag
            }
            
            const cleanTag = tag.trim();
            
            try {
                const response = await fetch(`${API_BASE}/videos/${videoId}/tags`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tag: cleanTag })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log(`‚úÖ Tag "${cleanTag}" added to video ${videoId}`);
                    
                    // Update custom tags display
                    const container = document.getElementById(`customTags_${videoId}`);
                    if (container) {
                        container.innerHTML = renderCustomTags(videoId, result.all_tags);
                    }
                    
                    // Show success feedback
                    const btn = event.target;
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '‚úÖ Added!';
                    btn.classList.add('bg-green-500', 'text-white');
                    btn.classList.remove('bg-blue-50', 'text-blue-600');
                    
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.classList.remove('bg-green-500', 'text-white');
                        btn.classList.add('bg-blue-50', 'text-blue-600');
                    }, 1500);
                } else {
                    alert(`Failed to add tag: ${result.error}`);
                }
            } catch (error) {
                console.error('Add tag error:', error);
                alert(`Error adding tag: ${error.message}`);
            }
        }
        
        // Add custom tag from search result
        async function addCustomTagFromResult(videoId, filename, resultIndex) {
            const tag = prompt(`Add custom tag for "${filename}":\n\nExamples:\n‚Ä¢ client-ad\n‚Ä¢ intro-shot\n‚Ä¢ b-roll-pack-1\n‚Ä¢ project-abc`);
            
            if (!tag || !tag.trim()) {
                return;
            }
            
            const cleanTag = tag.trim();
            
            try {
                const response = await fetch(`${API_BASE}/videos/${videoId}/tags`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tag: cleanTag })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log(`‚úÖ Tag "${cleanTag}" added to video ${videoId}`);
                    
                    // Refresh search results to show new tag
                    const currentQuery = searchInput.value.trim();
                    if (currentQuery) {
                        performSearch(currentQuery);
                    }
                } else {
                    alert(`Failed to add tag: ${result.error}`);
                }
            } catch (error) {
                console.error('Add tag error:', error);
                alert(`Error adding tag: ${error.message}`);
            }
        }
        
        // Delete custom tag from search result
        async function deleteCustomTagFromResult(videoId, tag, resultIndex) {
            if (!confirm(`Delete tag "${tag}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/videos/${videoId}/tags/${encodeURIComponent(tag)}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log(`‚úÖ Tag "${tag}" removed from video ${videoId}`);
                    
                    // Refresh search results to remove tag
                    const currentQuery = searchInput.value.trim();
                    if (currentQuery) {
                        performSearch(currentQuery);
                    }
                } else {
                    alert(`Failed to delete tag: ${result.error}`);
                }
            } catch (error) {
                console.error('Delete tag error:', error);
                alert(`Error deleting tag: ${error.message}`);
            }
        }
        
        // Delete custom tag from video
        async function deleteCustomTag(videoId, tag) {
            if (!confirm(`Delete tag "${tag}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/videos/${videoId}/tags/${encodeURIComponent(tag)}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log(`‚úÖ Tag "${tag}" removed from video ${videoId}`);
                    
                    // Update custom tags display
                    const container = document.getElementById(`customTags_${videoId}`);
                    if (container) {
                        container.innerHTML = renderCustomTags(videoId, result.remaining_tags);
                    }
                } else {
                    alert(`Failed to delete tag: ${result.error}`);
                }
            } catch (error) {
                console.error('Delete tag error:', error);
                alert(`Error deleting tag: ${error.message}`);
            }
        }

        function playClip(result, resultIndex = -1) {
            currentResultIndex = resultIndex;
            const videoUrl = `${API_BASE}/uploads/${result.filename}?v=${Date.now()}`;
            const isGif = result.filename.toLowerCase().endsWith('.gif');
            const videoLoading = document.getElementById('videoLoading');
            
            // Show GIF player or video player based on file type
            if (isGif) {
                videoPlayer.classList.add('hidden');
                gifPlayer.classList.remove('hidden');
                gifPlayer.src = videoUrl;
            } else {
                gifPlayer.classList.add('hidden');
                videoPlayer.classList.remove('hidden');
                
                // Show loading indicator
                videoLoading.classList.remove('hidden');
                
                videoPlayer.src = videoUrl;
                videoPlayer.currentTime = result.start_time;
                
                // Hide loading when video can play
                videoPlayer.oncanplay = () => {
                    videoLoading.classList.add('hidden');
                    videoPlayer.play();
                };
                
                // Also hide loading on error
                videoPlayer.onerror = () => {
                    videoLoading.classList.add('hidden');
                    alert('Error loading video. Please try again.');
                };
            }
            
            document.getElementById('modalTitle').textContent = result.filename;
            document.getElementById('clipTranscript').textContent = result.text;
            document.getElementById('timeInfo').textContent = isGif 
                ? `Animated GIF ‚Ä¢ Duration: ${result.duration.toFixed(1)}s`
                : `Playing from ${formatTime(result.start_time)} to ${formatTime(result.end_time)} (${result.duration.toFixed(1)}s)`;
            
            // Update navigation buttons
            updateNavigationButtons();
            
            videoModal.classList.remove('hidden');
            videoModal.classList.add('flex');
        }
        
        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevResult');
            const nextBtn = document.getElementById('nextResult');
            
            if (!prevBtn || !nextBtn) return;
            
            if (currentResultIndex <= 0 || currentDisplayedResults.length === 0) {
                prevBtn.disabled = true;
            } else {
                prevBtn.disabled = false;
            }
            
            if (currentResultIndex >= currentDisplayedResults.length - 1 || currentResultIndex < 0) {
                nextBtn.disabled = true;
            } else {
                nextBtn.disabled = false;
            }
        }
        
        // Play video from library (starts at beginning)
        async function playVideoFromLibrary(video) {
            const videoUrl = `${API_BASE}/uploads/${video.filename}`;
            const isGif = video.filename.toLowerCase().endsWith('.gif');
            
            // Show GIF player or video player based on file type
            if (isGif) {
                videoPlayer.classList.add('hidden');
                gifPlayer.classList.remove('hidden');
                gifPlayer.src = videoUrl;
            } else {
                gifPlayer.classList.add('hidden');
                videoPlayer.classList.remove('hidden');
                videoPlayer.src = videoUrl;
                videoPlayer.currentTime = 0;
                videoPlayer.play();
            }
            
            document.getElementById('modalTitle').textContent = video.filename;
            document.getElementById('clipTranscript').textContent = isGif 
                ? `Animated GIF ‚Ä¢ ${video.clip_count} searchable segments`
                : `Full video - ${video.clip_count} clips available`;
            document.getElementById('timeInfo').textContent = 
                `Duration: ${formatTime(video.duration)} ‚Ä¢ ${video.clip_count} searchable segments`;
            
            videoModal.classList.remove('hidden');
            videoModal.classList.add('flex');
        }

        // Close modal
        document.getElementById('closeModal').addEventListener('click', () => {
            videoModal.classList.add('hidden');
            videoModal.classList.remove('flex');
            videoPlayer.pause();
            gifPlayer.src = '';
        });

        // Close modal on background click
        videoModal.addEventListener('click', (e) => {
            if (e.target === videoModal) {
                videoModal.classList.add('hidden');
                videoModal.classList.remove('flex');
                videoPlayer.pause();
                gifPlayer.src = '';
            }
        });
        
        // Previous/Next navigation
        document.getElementById('prevResult').addEventListener('click', () => {
            if (currentResultIndex > 0) {
                const prevResult = currentDisplayedResults[currentResultIndex - 1];
                playClip(prevResult, currentResultIndex - 1);
            }
        });
        
        document.getElementById('nextResult').addEventListener('click', () => {
            if (currentResultIndex < currentDisplayedResults.length - 1) {
                const nextResult = currentDisplayedResults[currentResultIndex + 1];
                playClip(nextResult, currentResultIndex + 1);
            }
        });
        
        // Inline star rating from result cards
        function showStarRating(clipId, resultIndex) {
            const currentRating = clipRatings[clipId] || 0;
            const stars = prompt(`Rate this clip (1-5 stars):\n\nCurrent rating: ${currentRating > 0 ? currentRating + ' ‚≠ê' : 'Not rated'}\n\nEnter 1-5:`, currentRating || '');
            
            if (stars === null) return; // Cancelled
            
            const rating = parseInt(stars);
            if (isNaN(rating) || rating < 1 || rating > 5) {
                alert('Please enter a number between 1 and 5');
                return;
            }
            
            clipRatings[clipId] = rating;
            localStorage.setItem('clipRatings', JSON.stringify(clipRatings));
            
            alert(`Rated ${rating} ‚≠ê! This clip will appear ${rating >= 4 ? 'higher' : 'lower'} in future searches.`);
            
            // Refresh the display to show updated rating
            const query = searchInput.value.trim();
            if (query) {
                displayResults(allSearchResults, query, false);
            }
        }
        
        // Re-process video with UI feedback (for old and new videos)
        async function reprocessVideoWithUI(videoId, filename) {
            const btnId = `genVisBtn_${videoId}`;
            const button = document.getElementById(btnId);
            
            // Confirm with user (enhanced message for nuanced emotions)
            if (!confirm(`üé® Regenerate Visual Analysis for "${filename}"?\n\nThis will:\n‚úÖ Analyze video frames with AI\n‚úÖ Detect actors & series/movies\n‚úÖ Generate nuanced emotions (sarcasm, nervous anticipation, etc.)\n‚úÖ Extract on-screen text (OCR)\n‚úÖ Create comprehensive tags\n\n‚è±Ô∏è Time: ~1-2 minutes\nüí∞ Cost: ~$0.02-0.05 (OpenAI API)\n\nExisting metadata will be replaced with upgraded analysis.`)) {
                return;
            }
            
            console.log(`üé® Starting reprocess for video ${videoId}: ${filename}`);
            
            // Update button state: PROCESSING
            if (button) {
                button.disabled = true;
                button.className = 'flex-1 bg-yellow-500 text-white text-xs px-3 py-1 rounded font-medium cursor-wait';
                button.innerHTML = '‚è≥ Processing...';
            }
            
            try {
                // Show global progress indicator
                uploadProgress.classList.remove('hidden');
                uploadStatus.textContent = 'üé® Regenerating visual analysis with nuanced emotions...';
                currentFile.textContent = `Analyzing: ${filename}`;
                progressBar.style.width = '30%';
                
                console.log(`üì° Calling API: /reprocess/${videoId}`);
                
                // Call reprocess API
                const response = await fetch(`${API_BASE}/reprocess/${videoId}`, {
                    method: 'POST'
                });
                
                console.log(`üìä Response status: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}`);
                }
                
                const result = await response.json();
                console.log('üìã Reprocess result:', result);
                
                progressBar.style.width = '100%';
                
                // Hide progress
                setTimeout(() => {
                    uploadProgress.classList.add('hidden');
                    progressBar.style.width = '0%';
                }, 1000);
                
                if (result.success) {
                    console.log(`‚úÖ Success! ${result.visual_frames_added} frames added`);
                    
                    // Update button state: COMPLETE
                    if (button) {
                        button.className = 'flex-1 bg-green-500 text-white text-xs px-3 py-1 rounded font-medium';
                        button.innerHTML = '‚úÖ Complete!';
                        
                        // After 2 seconds, change to "Regenerate"
                        setTimeout(() => {
                            button.disabled = false;
                            button.className = 'flex-1 bg-purple-500 hover:bg-purple-600 text-white text-xs px-3 py-1 rounded font-medium transition-colors';
                            button.innerHTML = 'üîÑ Regenerate Visuals';
                        }, 2000);
                    }
                    
                    // Show success message
                    alert(`‚úÖ Visual Analysis Complete!\n\nüìä ${result.visual_frames_added} frames analyzed\nüé≠ Nuanced emotions detected\nüé¨ Actors & series identified\nüìù On-screen text extracted\n\nVideo is now fully searchable with advanced metadata!`);
                    
                    // Reload library to show updated data
                    loadLibrary();
                    
                } else if (result.message) {
                    console.warn('‚ö†Ô∏è Message from server:', result.message);
                    
                    // Update button state: ERROR
                    if (button) {
                        button.disabled = false;
                        button.className = 'flex-1 bg-orange-500 hover:bg-orange-600 text-white text-xs px-3 py-1 rounded font-medium';
                        button.innerHTML = '‚ö†Ô∏è Try Again';
                    }
                    
                    alert(`‚ö†Ô∏è ${result.message}`);
                } else {
                    throw new Error(result.error || 'Unknown error');
                }
                
            } catch (error) {
                console.error('‚ùå Reprocess error:', error);
                
                // Hide progress
                uploadProgress.classList.add('hidden');
                progressBar.style.width = '0%';
                
                // Update button state: ERROR
                if (button) {
                    button.disabled = false;
                    button.className = 'flex-1 bg-red-500 hover:bg-red-600 text-white text-xs px-3 py-1 rounded font-medium';
                    button.innerHTML = '‚ùå Failed - Retry';
                }
                
                // Show error message
                alert(`‚ùå Error reprocessing video:\n\n${error.message}\n\nPlease check:\n‚Ä¢ Video file exists in uploads folder\n‚Ä¢ OpenAI API key is valid\n‚Ä¢ Server logs for details`);
            }
        }
        
        // Legacy function (kept for compatibility)
        async function reprocessVideo(videoId, filename) {
            return reprocessVideoWithUI(videoId, filename);
        }
        
        // Delete video function
        async function deleteVideo(videoId, filename) {
            if (!confirm(`Delete "${filename}"?\n\nThis will remove:\n- Video file\n- All transcript clips\n- All visual frames\n- Thumbnail\n\nThis cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/delete/${videoId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Video deleted successfully!');
                    loadLibrary();  // Refresh library
                } else {
                    alert('Failed to delete video: ' + result.error);
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Error deleting video: ' + error.message);
            }
        }
        
        // ========== FILTER FUNCTIONALITY ==========
        
        let selectedEmotions = new Set();
        let selectedGenres = new Set();
        let availableEmotions = new Set();
        let availableGenres = new Set();
        
        // Toggle filter panel
        function toggleFilter() {
            const panel = document.getElementById('filterPanel');
            panel.classList.toggle('hidden');
            
            // Load available filters on first open
            if (!panel.classList.contains('hidden') && availableEmotions.size === 0) {
                loadAvailableFilters();
            }
        }
        
        // Load available emotions and genres from database
        async function loadAvailableFilters() {
            try {
                const response = await fetch(`${API_BASE}/filters`);
                const data = await response.json();
                
                availableEmotions = new Set(data.emotions || []);
                availableGenres = new Set(data.genres || []);
                
                renderFilterOptions();
            } catch (error) {
                console.error('Error loading filters:', error);
            }
        }
        
        // Render filter option buttons
        function renderFilterOptions() {
            const emotionContainer = document.getElementById('emotionFilters');
            const genreContainer = document.getElementById('genreFilters');
            
            // Render emotions
            emotionContainer.innerHTML = '';
            const sortedEmotions = Array.from(availableEmotions).sort();
            sortedEmotions.forEach(emotion => {
                const btn = createFilterButton(emotion, 'emotion');
                emotionContainer.appendChild(btn);
            });
            
            // Render genres
            genreContainer.innerHTML = '';
            const sortedGenres = Array.from(availableGenres).sort();
            sortedGenres.forEach(genre => {
                const btn = createFilterButton(genre, 'genre');
                genreContainer.appendChild(btn);
            });
        }
        
        // Create filter button element
        function createFilterButton(label, type) {
            const btn = document.createElement('button');
            btn.className = 'px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm transition-colors';
            btn.textContent = label;
            btn.onclick = () => toggleFilterSelection(label, type, btn);
            return btn;
        }
        
        // Toggle filter selection
        function toggleFilterSelection(label, type, button) {
            const targetSet = type === 'emotion' ? selectedEmotions : selectedGenres;
            
            if (targetSet.has(label)) {
                targetSet.delete(label);
                button.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
                button.classList.add('bg-white', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
            } else {
                targetSet.add(label);
                button.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
                button.classList.remove('bg-white', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
            }
            
            updateFilterCount();
            // Don't apply filters automatically - wait for user to click Search button
        }
        
        // Update filter count badge
        function updateFilterCount() {
            const count = selectedEmotions.size + selectedGenres.size;
            const badge = document.getElementById('filterCount');
            
            if (count > 0) {
                badge.textContent = count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }
        
        // Clear all filters
        function clearFilters() {
            selectedEmotions.clear();
            selectedGenres.clear();
            
            // Reset button styles
            document.querySelectorAll('#emotionFilters button, #genreFilters button').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
                btn.classList.add('bg-white', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
            });
            
            updateFilterCount();
        }
        
        // Apply filters and perform search (called by Search button in filter panel)
        function applyFiltersAndSearch() {
            const query = searchInput.value.trim();
            
            // Perform search with selected filters
            if (query || selectedEmotions.size > 0 || selectedGenres.size > 0) {
                performSearch(query);
            } else {
                // If no query and no filters, show library
                resultsSection.classList.add('hidden');
                noResultsState.classList.add('hidden');
                librarySection.classList.remove('hidden');
            }
            
            // Close filter panel after search
            document.getElementById('filterPanel').classList.add('hidden');
        }
        
        // Click outside filter panel to close
        document.addEventListener('click', function(event) {
            const filterPanel = document.getElementById('filterPanel');
            const filterToggle = document.getElementById('filterToggle');
            const filterPanelContent = document.getElementById('filterPanelContent');
            
            // Check if click is outside filter panel and filter button
            if (!filterPanel.classList.contains('hidden') && 
                !filterPanelContent.contains(event.target) && 
                !filterToggle.contains(event.target)) {
                filterPanel.classList.add('hidden');
            }
        });
        
        // Category Upload Modal
        const categoryModal = document.getElementById('categoryModal');
        const categoryVideosBtn = document.getElementById('categoryVideosBtn');
        const categoryGIFsBtn = document.getElementById('categoryGIFsBtn');
        const categoryPSBtn = document.getElementById('categoryPSBtn');
        const categoryIntroBtn = document.getElementById('categoryIntroBtn');
        const closeCategoryModal = document.getElementById('closeCategoryModal');
        let selectedCategory = null;
        let pendingFiles = null;
        
        function showCategoryModal(files) {
            pendingFiles = files;
            selectedCategory = null;
            categoryModal.classList.remove('hidden');
            // Reset button styles
            [categoryVideosBtn, categoryGIFsBtn, categoryPSBtn, categoryIntroBtn].forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white');
                btn.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
            });
        }
        
        function selectCategory(category, button) {
            selectedCategory = category;
            // Update button styles
            [categoryVideosBtn, categoryGIFsBtn, categoryPSBtn, categoryIntroBtn].forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white');
                btn.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
            });
            button.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
            button.classList.add('bg-blue-500', 'text-white');
        }
        
        function proceedWithUpload() {
            if (!selectedCategory) {
                alert('Please select a category before uploading');
                return;
            }
            categoryModal.classList.add('hidden');
            if (pendingFiles) {
                handleFilesWithCategory(pendingFiles, selectedCategory);
                pendingFiles = null;
                selectedCategory = null;
            }
        }
        
        closeCategoryModal.addEventListener('click', () => {
            categoryModal.classList.add('hidden');
            pendingFiles = null;
            selectedCategory = null;
        });
        
        categoryVideosBtn.addEventListener('click', () => selectCategory('Videos', categoryVideosBtn));
        categoryGIFsBtn.addEventListener('click', () => selectCategory('GIFs', categoryGIFsBtn));
        categoryPSBtn.addEventListener('click', () => selectCategory('PS', categoryPSBtn));
        categoryIntroBtn.addEventListener('click', () => selectCategory('Intro', categoryIntroBtn));
        
        // Audio/Visual Toggle
        const toggleVisual = document.getElementById('toggleVisual');
        const toggleAudio = document.getElementById('toggleAudio');
        
        toggleVisual.addEventListener('click', () => {
            currentResultsFilter = 'visual';
            toggleVisual.classList.add('bg-blue-500', 'text-white');
            toggleVisual.classList.remove('text-gray-700', 'dark:text-gray-300', 'hover:bg-gray-300', 'dark:hover:bg-gray-600');
            toggleAudio.classList.remove('bg-blue-500', 'text-white');
            toggleAudio.classList.add('text-gray-700', 'dark:text-gray-300', 'hover:bg-gray-300', 'dark:hover:bg-gray-600');
            filterAndDisplayResults();
        });
        
        toggleAudio.addEventListener('click', () => {
            currentResultsFilter = 'audio';
            toggleAudio.classList.add('bg-blue-500', 'text-white');
            toggleAudio.classList.remove('text-gray-700', 'dark:text-gray-300', 'hover:bg-gray-300', 'dark:hover:bg-gray-600');
            toggleVisual.classList.remove('bg-blue-500', 'text-white');
            toggleVisual.classList.add('text-gray-700', 'dark:text-gray-300', 'hover:bg-gray-300', 'dark:hover:bg-gray-600');
            filterAndDisplayResults();
        });
        
        function filterAndDisplayResults() {
            const filtered = allSearchResults.filter(r => r.source === currentResultsFilter);
            displayResults(filtered, searchInput.value.trim(), false); // false = don't store again
        }
        
        // Category filtering in Library
        function filterLibraryByCategory(category) {
            currentLibraryCategory = category;
            
            // Update pill styles
            document.querySelectorAll('.category-pill').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white');
                btn.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
            });
            
            const activeBtn = category === 'Videos' ? document.getElementById('catVideos') :
                             category === 'GIFs' ? document.getElementById('catGIFs') :
                             category === 'PS' ? document.getElementById('catPS') :
                             document.getElementById('catIntro');
            if (activeBtn) {
                activeBtn.classList.add('bg-blue-500', 'text-white');
                activeBtn.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
            }
            
            // Filter and display
            const filtered = allLibraryVideos.filter(v => v.category === category);
            displayLibraryVideos(filtered);
        }
        
        function displayLibraryVideos(videos) {
            libraryGrid.innerHTML = '';
            if (videos.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }
            emptyState.classList.add('hidden');
            
            videos.forEach(video => {
                const card = createVideoCard(video);
                libraryGrid.appendChild(card);
            });
        }
    </script>
</body>
</html>
